<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8" />
<title>Chatbot - ‡∏Ñ‡∏ì‡∏∞‡∏ß‡∏¥‡∏®‡∏ß‡∏Å‡∏£‡∏£‡∏°‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="chat.css">
</head>
<body>
  <div class="panel" role="application" aria-label="Chatbot">
    <div class="head">
      <div class="head-left">
        <div class="logo-container">
          <a href="https://eng.rmutp.ac.th/" target="_blank" class="logo-link" rel="noopener">
            <img src="rmutp-logo.png" alt="RMUTP Engineering Logo" class="logo">
          </a>
          <div class="text-container">
            <div class="title">‡πÅ‡∏ä‡∏ó‡∏ö‡∏≠‡∏ó ‡∏Ñ‡∏ì‡∏∞‡∏ß‡∏¥‡∏®‡∏ß‡∏Å‡∏£‡∏£‡∏°‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå</div>
            <div class="subtitle">‡∏°‡∏´‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ‡∏£‡∏≤‡∏ä‡∏°‡∏á‡∏Ñ‡∏•‡∏û‡∏£‡∏∞‡∏ô‡∏Ñ‡∏£</div>
          </div>
        </div>
      </div>
      <button type="button" class="theme-toggle" id="themeToggle" aria-label="‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î‡∏°‡∏∑‡∏î">
        <span class="theme-icon">üåô</span>
        <span class="theme-label">‡πÇ‡∏´‡∏°‡∏î‡∏°‡∏∑‡∏î</span>
      </button>
    </div>

    <div class="body" id="chatlog" aria-live="polite">
      <div class="messages-container">
        <!-- ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ä‡∏ó‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà -->
      </div>
    </div>

    <footer class="footer">
      <div class="footer-container">
        <div class="input-wrapper">
          <div class="chat-input-container">
            <input id="userInput" 
                   type="text" 
                   placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ñ‡∏≤‡∏° ‡πÄ‡∏ä‡πà‡∏ô '‡∏Ç‡πà‡∏≤‡∏ß' '‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Ñ‡∏ì‡∏∞' '‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå'..." 
                   onkeypress="if(event.key==='Enter') sendMessage()">
            <button id="sendBtn" onclick="sendMessage()">
              ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
            </button>
          </div>
        </div>
      </div>
    </footer>
  </div>

<script>
const chatlog = document.getElementById('chatlog');
const messagesContainer = chatlog.querySelector('.messages-container');
const themeToggleButton = document.getElementById('themeToggle');
const themeStorageKey = 'eng-chatbot-theme';
const prefersDark = window.matchMedia('(prefers-color-scheme: dark)');

function updateThemeToggle(mode) {
  if (!themeToggleButton) return;
  const iconEl = themeToggleButton.querySelector('.theme-icon');
  const labelEl = themeToggleButton.querySelector('.theme-label');
  if (mode === 'dark') {
    if (iconEl) iconEl.textContent = '‚òÄÔ∏è';
    if (labelEl) labelEl.textContent = '‡πÇ‡∏´‡∏°‡∏î‡∏™‡∏ß‡πà‡∏≤‡∏á';
    themeToggleButton.setAttribute('aria-label', '‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î‡∏°‡∏∑‡∏î');
  } else {
    if (iconEl) iconEl.textContent = 'üåô';
    if (labelEl) labelEl.textContent = '‡πÇ‡∏´‡∏°‡∏î‡∏°‡∏∑‡∏î';
    themeToggleButton.setAttribute('aria-label', '‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î‡∏°‡∏∑‡∏î');
  }
}

function applyTheme(mode) {
  const enableDark = mode === 'dark';
  document.body.classList.toggle('dark-theme', enableDark);
  updateThemeToggle(enableDark ? 'dark' : 'light');
}

const storedTheme = localStorage.getItem(themeStorageKey);
const initialTheme = storedTheme || (prefersDark.matches ? 'dark' : 'light');
applyTheme(initialTheme);

if (themeToggleButton) {
  themeToggleButton.addEventListener('click', () => {
    const next = document.body.classList.contains('dark-theme') ? 'light' : 'dark';
    applyTheme(next);
    localStorage.setItem(themeStorageKey, next);
  });
}

const handlePrefersChange = event => {
  if (localStorage.getItem(themeStorageKey)) return;
  applyTheme(event.matches ? 'dark' : 'light');
};

if (typeof prefersDark.addEventListener === 'function') {
  prefersDark.addEventListener('change', handlePrefersChange);
} else if (typeof prefersDark.addListener === 'function') {
  prefersDark.addListener(handlePrefersChange);
}

// Quick reply suggestions
function showQuickReplies() {
  const suggestions = ['‡∏Ç‡πà‡∏≤‡∏ß‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î', '‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Ñ‡∏ì‡∏∞', '‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå', '‡∏ó‡∏∏‡∏ô‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤', '‡∏™‡∏≤‡∏Ç‡∏≤‡∏ß‡∏¥‡∏ä‡∏≤'];
  const wrapper = document.createElement('div');
  wrapper.style.clear = 'both';
  wrapper.style.margin = '15px 0';
  wrapper.innerHTML = '<div style="color:#666; font-size:0.9em; margin-bottom:8px;">üí° ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:</div>';
  
  const btnsContainer = document.createElement('div');
  btnsContainer.style.display = 'flex';
  btnsContainer.style.gap = '8px';
  btnsContainer.style.flexWrap = 'wrap';
  
  suggestions.forEach(text => {
    const btn = document.createElement('button');
    btn.textContent = text;
    btn.style.cssText = 'background:#a90d2c; color:white; border:none; padding:10px 18px; border-radius:20px; cursor:pointer; font-family:Kanit; font-size:0.95em; font-weight:500; transition:all 0.3s; box-shadow:0 2px 6px rgba(169,13,44,0.3);';
    btn.onmouseover = () => {
      btn.style.background = '#8b0823';
      btn.style.transform = 'translateY(-2px)';
      btn.style.boxShadow = '0 4px 12px rgba(169,13,44,0.4)';
    };
    btn.onmouseout = () => {
      btn.style.background = '#a90d2c';
      btn.style.transform = 'translateY(0)';
      btn.style.boxShadow = '0 2px 6px rgba(169,13,44,0.3)';
    };
    btn.onclick = () => {
      document.getElementById('userInput').value = text;
      sendMessage();
      wrapper.remove();
    };
    btnsContainer.appendChild(btn);
  });
  
  wrapper.appendChild(btnsContainer);
  messagesContainer.appendChild(wrapper);
  scrollBottom();
}

// Typing indicator
function showTyping() {
  const wrapper = document.createElement('div');
  wrapper.id = 'typingIndicator';
  wrapper.style.clear = 'both';
  wrapper.style.overflow = 'hidden';
  wrapper.style.width = '100%';
  
  const indicator = document.createElement('div');
  indicator.className = 'msg bot';
  indicator.innerHTML = `
    <div class="bot-container">
      <div class="bot-icon"><img src="rmutp-logo1.png" alt="Bot"></div>
      <div class="bot-content" style="padding:12px 18px;">
        <span style="display:inline-block; animation:blink 1.4s infinite;">‚óè</span>
        <span style="display:inline-block; animation:blink 1.4s 0.2s infinite;">‚óè</span>
        <span style="display:inline-block; animation:blink 1.4s 0.4s infinite;">‚óè</span>
      </div>
    </div>
  `;
  
  wrapper.appendChild(indicator);
  messagesContainer.appendChild(wrapper);
  scrollBottom();
}

function hideTyping() {
  const typing = document.getElementById('typingIndicator');
  if(typing) typing.remove();
}

function appendUser(text){
  const wrapper = document.createElement('div');
  wrapper.style.clear = 'both';
  wrapper.style.overflow = 'hidden';
  wrapper.style.width = '100%';
  
  const d = document.createElement('div');
  d.className = 'msg user';
  d.innerHTML = escapeHtml(text) + `<div class="meta">${timeNow()}</div>`;
  
  wrapper.appendChild(d);
  messagesContainer.appendChild(wrapper);
  scrollBottom();
}

function appendBot(text){
  hideTyping();
  const wrapper = document.createElement('div');
  wrapper.style.clear = 'both';
  wrapper.style.overflow = 'hidden';
  wrapper.style.width = '100%';
  
  const d = document.createElement('div');
  d.className = 'msg bot';
  
  // ‡πÄ‡∏û‡∏¥‡πà‡∏° bot container ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏ß‡∏≤‡∏á‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
  const botContainer = document.createElement('div');
  botContainer.className = 'bot-container';
  
  // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏ö‡∏≠‡∏ó
  const botIcon = document.createElement('div');
  botIcon.className = 'bot-icon';
  botIcon.innerHTML = `<img src="rmutp-logo1.png" alt="RMUTP Bot Icon">`;
  
  // ‡∏™‡∏£‡πâ‡∏≤‡∏á content container
  const contentContainer = document.createElement('div');
  contentContainer.className = 'bot-content';
  
  // ‡πÅ‡∏õ‡∏•‡∏á \n ‡πÄ‡∏õ‡πá‡∏ô <br> ‡πÅ‡∏•‡∏∞‡πÅ‡∏õ‡∏•‡∏á emoji ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏™‡∏ß‡∏¢
  const formattedText = text
    .split('\n')
    .map(line => escapeHtml(line))
    .join('<br>');
  
  contentContainer.innerHTML = formattedText + `<div class="meta">${timeNow()}</div>`;
  
  botContainer.appendChild(botIcon);
  botContainer.appendChild(contentContainer);
  d.appendChild(botContainer);
  
  wrapper.appendChild(d);
  messagesContainer.appendChild(wrapper);
  scrollBottom();
}

function cleanSummary(text){
  return String(text || '')
    .replace(/<[^>]+>/g, ' ')
    .replace(/\s+/g, ' ')
    .trim();
}

function truncateText(text, maxLength){
  if(!text) return '';
  if(text.length <= maxLength) return text;
  const sliced = text.slice(0, maxLength);
  return sliced.replace(/\s+\S*$/, '').trim() + '‚Ä¶';
}

function normalizeNewsLabel(label){
  const key = String(label || '').trim();
  const map = {
    '‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Ñ‡∏ì‡∏∞‡∏ß‡∏¥‡∏®‡∏ß‡∏Å‡∏£‡∏£‡∏°‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå': '‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Ñ‡∏ì‡∏∞‡∏ß‡∏¥‡∏®‡∏ß‡∏Å‡∏£‡∏£‡∏°‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå',
    '‡∏Å‡∏¥‡∏à‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Ñ‡∏ì‡∏∞‡∏ß‡∏¥‡∏®‡∏ß‡∏Å‡∏£‡∏£‡∏°‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå': '‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Ñ‡∏ì‡∏∞‡∏ß‡∏¥‡∏®‡∏ß‡∏Å‡∏£‡∏£‡∏°‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå',
    '‡∏Ç‡πà‡∏≤‡∏ß‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå': '‡∏Ç‡πà‡∏≤‡∏ß‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå',
    '‡∏Ç‡πà‡∏≤‡∏ß': '‡∏Ç‡πà‡∏≤‡∏ß‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå',
    '‡∏Ç‡πà‡∏≤‡∏ß‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏≠‡∏á': '‡∏Ç‡πà‡∏≤‡∏ß‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏≠‡∏á'
  };
  return map[key] || key;
}

function formatNewsCategory(source){
  if(!source) return '‡∏Ç‡πà‡∏≤‡∏ß‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå';
  const parts = String(source).split(':');
  const label = normalizeNewsLabel(parts.slice(1).join(':'));
  if(label) return label;

  const baseRaw = String(parts[0] || '').trim();
  if(baseRaw === 'scraped') return '‡∏Ç‡πà‡∏≤‡∏ß‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå';
  if(baseRaw === 'manual') return '‡∏Ç‡πà‡∏≤‡∏ß‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏≠‡∏á';
  return normalizeNewsLabel(baseRaw) || '‡∏Ç‡πà‡∏≤‡∏ß‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå';
}

function newsCategoryLink(label){
  const normalized = normalizeNewsLabel(label);
  const map = {
    '‡∏Ç‡πà‡∏≤‡∏ß‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå': 'https://eng.rmutp.ac.th/category/public-relations/',
    '‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Ñ‡∏ì‡∏∞‡∏ß‡∏¥‡∏®‡∏ß‡∏Å‡∏£‡∏£‡∏°‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå': 'https://eng.rmutp.ac.th/category/faculty-activities/'
  };
  return map[normalized] || 'https://eng.rmutp.ac.th/';
}

function appendNews(items){
  hideTyping();
  const wrapper = document.createElement('div');
  wrapper.style.clear = 'both';
  wrapper.style.overflow = 'hidden';
  wrapper.style.width = '100%';

  const message = document.createElement('div');
  message.className = 'msg bot';

  const botContainer = document.createElement('div');
  botContainer.className = 'bot-container';

  const botIcon = document.createElement('div');
  botIcon.className = 'bot-icon';
  botIcon.innerHTML = `<img src="rmutp-logo1.png" alt="RMUTP Bot Icon">`;

  const contentContainer = document.createElement('div');
  contentContainer.className = 'bot-content news-bot-content';

  const topItems = items.slice(0, 4);

  if(topItems.length === 0) {
    contentContainer.innerHTML = `
      <div class="news-response">
        <p class="news-summary">‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πà‡∏≤‡∏ß‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏à‡∏≤‡∏Å‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå‡∏Ñ‡∏ì‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö</p>
      </div>
      <div class="meta">${timeNow()}</div>
    `;
  } else {
    const categories = Array.from(new Set(topItems.map(item => formatNewsCategory(item.source)))).filter(Boolean);
    const headerLabel = categories.length === 1 ? categories[0] : '‡∏Ç‡πà‡∏≤‡∏ß‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î';
    const chipsHtml = categories.map(cat => `<span class="news-chip">${escapeHtml(cat)}</span>`).join('');
  const moreUrl = categories.length === 1 ? newsCategoryLink(categories[0]) : 'https://eng.rmutp.ac.th/';
  const extraCount = Math.max(items.length - topItems.length, 0);
  const footerNote = extraCount > 0 ? `<span class="news-footer-note">‡∏°‡∏µ‡∏≠‡∏µ‡∏Å ${extraCount} ‡∏Ç‡πà‡∏≤‡∏ß‡∏ö‡∏ô‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå</span>` : '';

    let newsHTML = '';
    topItems.forEach((item, index) => {
      const categoryLabel = formatNewsCategory(item.source);
      const summaryText = truncateText(cleanSummary(item.summary || ''), 150);
      newsHTML += `
        <article class="news-card">
          <div class="news-index">${String(index + 1).padStart(2, '0')}</div>
          <div class="news-details">
            <h4 class="news-item-title">${escapeHtml(item.title)}</h4>
            <div class="news-meta">
              <span class="news-date">üìÖ ${escapeHtml(item.date_post)}</span>
              ${categoryLabel ? `<span class="news-category">${escapeHtml(categoryLabel)}</span>` : ''}
            </div>
            ${summaryText ? `<p class="news-summary">${escapeHtml(summaryText)}</p>` : ''}
            <a class="news-link" href="${escapeHtml(item.url)}" target="_blank" rel="noopener">‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πà‡∏≤‡∏ß‡πÄ‡∏ï‡πá‡∏°</a>
          </div>
        </article>
      `;
    });

    contentContainer.innerHTML = `
      <div class="news-response">
        <div class="news-header">
          <div class="news-header-left">
            <div class="news-header-icon">üì∞</div>
            <div>
              <div class="news-header-title">${escapeHtml(headerLabel)}</div>
              <div class="news-header-subtitle">‡∏Ñ‡∏±‡∏î‡∏°‡∏≤ ${topItems.length} ‡∏Ç‡πà‡∏≤‡∏ß‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå‡∏Ñ‡∏ì‡∏∞</div>
            </div>
          </div>
          ${chipsHtml ? `<div class="news-chip-wrapper">${chipsHtml}</div>` : ''}
        </div>
        <div class="news-grid">${newsHTML}</div>
        <div class="news-footer">
          ${footerNote}
          <a class="news-more" href="${escapeHtml(moreUrl)}" target="_blank" rel="noopener">‡∏î‡∏π‡∏Ç‡πà‡∏≤‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‚Üí</a>
        </div>
      </div>
      <div class="meta">${timeNow()}</div>
    `;
  }

  botContainer.appendChild(botIcon);
  botContainer.appendChild(contentContainer);
  message.appendChild(botContainer);
  wrapper.appendChild(message);
  messagesContainer.appendChild(wrapper);
  scrollBottom();
}

function appendStaff(items){
  hideTyping();
  const wrapper = document.createElement('div');
  wrapper.style.clear = 'both';
  wrapper.style.overflow = 'hidden';
  wrapper.style.width = '100%';
  
  // Add header
  const header = document.createElement('div');
  header.style.cssText = 'margin:10px 0; color:#666; font-size:0.95em;';
  header.innerHTML = `üë• ‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£ ${items.length} ‡∏ó‡πà‡∏≤‡∏ô`;
  wrapper.appendChild(header);
  
  items.forEach(s=>{
    const card = document.createElement('div');
    card.className='card';
    card.innerHTML = `
      <div style="font-weight:700; color:#a90d2c;">${escapeHtml(s.fullname)}</div>
      <div class="small" style="color:#666;">${escapeHtml(s.title)} ‚Ä¢ ${escapeHtml(s.department||'')}</div>
      ${s.role ? `<div style="margin:5px 0;"><span style="background:#e3f2fd; padding:3px 10px; border-radius:10px; font-size:0.85em; color:#1976d2;">${escapeHtml(s.role)}</span></div>` : ''}
      <div style="margin-top:10px;">
        ${s.phone ? `üìû ${escapeHtml(s.phone)}` : ''} 
        ${s.phone && s.email ? ' ‚Ä¢ ' : ''}
        ${s.email ? `‚úâÔ∏è ${escapeHtml(s.email)}` : ''}
      </div>
    `;
    wrapper.appendChild(card);
  });
  
  messagesContainer.appendChild(wrapper);
  scrollBottom();
}

function sendMessage(){
  const input = document.getElementById('userInput');
  const txt = input.value.trim();
  if(!txt) return;
  appendUser(txt); 
  input.value=''; 
  showTyping();
  setTimeout(()=>callApi(txt),500); // ‡∏î‡∏µ‡πÄ‡∏•‡∏¢‡πå‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á typing indicator
}

function callApi(msg){
  const btn = document.getElementById('sendBtn'); 
  btn.disabled=true;
  
  fetch(`chatbot.php?msg=${encodeURIComponent(msg)}`)
    .then(r => r.text())
    .then(response => {
      btn.disabled = false;
      hideTyping();
      try {
        const json = JSON.parse(response);
        if(json.type === 'text'){ 
          appendBot(json.text); 
        }
        else if(json.type === 'news'){ 
          appendNews(json.items); 
        }
        else if(json.type === 'staff'){ 
          appendStaff(json.items); 
        }
        else if(json.type === 'contact'){ 
          appendBot(json.text); 
        }
        else {
          appendBot('‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢ ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
        }
      } catch(e) {
        appendBot(response);
      }
    })
    .catch(err => {
      btn.disabled = false;
      hideTyping();
      appendBot('‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢ ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
      console.error(err);
    });
}

function scrollBottom(){ 
  chatlog.scrollTop = chatlog.scrollHeight; 
}

function timeNow(){ 
  const d=new Date(); 
  return d.getHours().toString().padStart(2,'0')+':'+d.getMinutes().toString().padStart(2,'0'); 
}

function escapeHtml(str){ 
  return String(str||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); 
}

// Add CSS for typing animation
const style = document.createElement('style');
style.textContent = `
  @keyframes blink {
    0%, 20% { opacity: 0.2; }
    50% { opacity: 1; }
    100% { opacity: 0.2; }
  }
  .meta {
    font-size: 0.8em;
    color: rgba(255,255,255,0.7);
    margin-top: 6px;
    opacity: 0.8;
  }
  .bot-content .meta {
    color: #999;
  }
`;
document.head.appendChild(style);

// Initial greeting with quick replies
appendBot('‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö ‡∏ú‡∏°‡∏Ñ‡∏∑‡∏≠ EngBot ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏ì‡∏∞‡∏ß‡∏¥‡∏®‡∏ß‡∏Å‡∏£‡∏£‡∏°‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå RMUTP ü§ñ');
setTimeout(() => {
  appendBot('‡∏ú‡∏°‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ä‡πà‡∏ß‡∏¢‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ï‡πà‡∏≤‡∏á ‡πÜ ‡πÄ‡∏ä‡πà‡∏ô ‡∏Ç‡πà‡∏≤‡∏ß‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå, ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå, ‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Ñ‡∏ì‡∏∞ ‡πÅ‡∏•‡∏∞‡∏≠‡∏∑‡πà‡∏ô ‡πÜ ‡∏≠‡∏µ‡∏Å‡∏°‡∏≤‡∏Å‡∏°‡∏≤‡∏¢');
  showQuickReplies();
}, 800);
</script>
</body>
</html>
